#!/bin/bash

# Enable strict error handling
set -euo pipefail

# Trap errors and cleanup
trap 'echo "[ERROR] Script failed at line $LINENO"; exit 1' ERR

# Verify running as root
if [ "$EUID" -ne 0 ]; then
    echo "[ERROR] This script must be run as root"
    exit 1
fi

# Configuration Variables - EDIT THESE
REGION="<YOUR_AZURE_REGION>"
RESOURCE_GROUP="<YOUR_RESOURCE_GROUP>"
SUBSCRIPTION_ID="<YOUR_SUBSCRIPTION_ID>"
MACHINE_NAME="<YOUR_SWITCH_HOSTNAME>"
TENANT_ID="<YOUR_TENANT_ID>"

# DNS Servers - Provide space-separated list (e.g., "10.10.240.23 10.10.240.24" or "8.8.8.8")
# If empty, system DNS will be used
DNS_SERVERS="<DNS_SERVER_LIST>"

# Configuration Variables - EDIT THESE
WORKSPACE_ID="<LOG_ANALYTICS_WORKSPACE_ID>"
PRIMARY_KEY="<LOG_ANALYTICS_PRIMARY_KEY>"
SECONDARY_KEY="<LOG_ANALYTICS_SECONDARY_KEY>"
PARSER_URL="https://github.com/microsoft/arc-switch/releases/download/1.2510.3/cisco-nexus-unified-parser-1.2510.3-linux-amd64.tar.gz"
PARSER_PATH="/opt/cisco-parser"
TEMP_DIR="/tmp/cisco-parser-output"
AZURE_TEMP_DIR="/tmp/azure-logger"
AZCMAGENT_RPM_URL="https://github.com/microsoft/arc-switch/releases/download/v0.0.2-alpha-rpm/azcmagent-1.54.03131-2112.x86_64.rpm"

# Validation function
validate_configuration() {
    local errors=0
    
    # Check for placeholder values
    for var in REGION RESOURCE_GROUP SUBSCRIPTION_ID MACHINE_NAME TENANT_ID WORKSPACE_ID PRIMARY_KEY SECONDARY_KEY; do
        local value=$(eval echo \$"$var")
        if [[ "$value" == "<"*">" ]] || [ -z "$value" ]; then
            echo "[ERROR] Configuration variable '$var' is not set properly: $value"
            ((errors++))
        fi
    done
    
    # Validate WORKSPACE_ID format (should look like UUID)
    if ! [[ "$WORKSPACE_ID" =~ ^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$ ]]; then
        echo "[WARN] WORKSPACE_ID does not appear to be a valid UUID format: $WORKSPACE_ID"
    fi
    
    if [ $errors -gt 0 ]; then
        echo "[ERROR] Configuration validation failed with $errors error(s)"
        exit 1
    fi
}

echo "[INFO] Validating configuration..."
validate_configuration
echo "[INFO] Configuration validation passed"

# Check and handle existing services
echo "[INFO] Checking for existing Arc services..."
for service in himdsd arcproxyd extd gcad; do
    if [ -f "/etc/init.d/$service" ] && /etc/init.d/$service status &>/dev/null; then
        echo "[INFO] Service '$service' is already running. Will refresh it with this setup."
        /etc/init.d/$service stop 2>/dev/null || true
        sleep 2
    fi
done

# Download and install Arc agent RPM (skip if already installed)
if rpm -q azcmagent >/dev/null 2>&1; then
    echo "[INFO] Arc agent already installed; skipping download and install"
else
    echo "[INFO] Preparing Arc agent RPM download..."
    cd /opt
    rpm_file="azcmagent.rpm"
    rpm_path="$(pwd)/$rpm_file"
    download_retries=3
    retry_count=0

    # Reuse existing RPM if present and non-empty
    if [ -f "$rpm_path" ] && [ -s "$rpm_path" ]; then
        file_size=$(du -h "$rpm_path" | cut -f1)
        echo "[INFO] Found existing Arc agent RPM ($file_size) at $rpm_path; reusing"
    else
        # Attempt download with retry logic
        while [ $retry_count -lt $download_retries ]; do
            echo "[INFO] Download attempt $((retry_count + 1))/$download_retries"
            if wget --timeout=30 --tries=2 -q -O "$rpm_file" "$AZCMAGENT_RPM_URL" 2>&1; then
                if [ -f "$rpm_file" ] && [ -s "$rpm_file" ]; then
                    file_size=$(du -h "$rpm_file" | cut -f1)
                    echo "[INFO] Arc agent RPM downloaded successfully ($file_size)"
                    break
                fi
            fi
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $download_retries ]; then
                echo "[WARN] Download attempt $retry_count failed, retrying in 5 seconds..."
                sleep 5
                rm -f "$rpm_file"
            fi
        done

        if [ $retry_count -eq $download_retries ]; then
            echo "[ERROR] Failed to download Arc agent RPM after $download_retries attempts"
            exit 1
        fi
    fi

    echo "[INFO] Installing Arc agent RPM..."
    if ! rpm -ivh "$rpm_file" 2>/dev/null && ! rpm -Uvh "$rpm_file" 2>/dev/null; then
        echo "[WARN] Arc agent RPM installation encountered issues, continuing..."
    fi
    rm -f "$rpm_file"
fi

# PART 1: DNS AND GC CONFIG SETUP

echo "[INFO] Configuring GuestConfig services..."
mkdir -p /opt/GC_Service/GC /opt/GC_Ext/GC || true

cat > /opt/GC_Service/GC/gc.config <<'EOF'
{
    "ServiceType": "GCArc"
}
EOF

cat > /opt/GC_Ext/GC/gc.config <<'EOF'
{
    "ServiceType": "Extension"
}
EOF

echo "[INFO] Configuring DNS servers..."
if [ -n "$DNS_SERVERS" ] && [ "$DNS_SERVERS" != "<DNS_SERVER_LIST>" ]; then
    echo "[INFO] Using user-provided DNS servers: $DNS_SERVERS"
    echo "# DNS configuration for Arc switch" > /etc/resolv.conf
    for dns_server in $DNS_SERVERS; do
        echo "nameserver $dns_server" >> /etc/resolv.conf
    done
    
    # Also update template for NX-OS
    mkdir -p /isan/etc/template/etc || true
    cp /etc/resolv.conf /isan/etc/template/etc/resolv.conf
    echo "[INFO] DNS servers configured: $DNS_SERVERS"
else
    echo "[INFO] DNS_SERVERS not provided, keeping system defaults"
fi

# PART 2: MAKE ARC BINARIES EXECUTABLE

echo "[INFO] Setting permissions for Arc binaries..."

set_binary_permissions() {
    local binary="$1"
    chmod +x "$binary" 2>/dev/null
    chmod 755 "$binary" 2>/dev/null
    chown root:root "$binary" 2>/dev/null
    chmod u+s "$binary" 2>/dev/null
    setcap 'cap_dac_override,cap_dac_read_search,cap_fowner,cap_setgid,cap_setuid,cap_net_bind_service,cap_sys_admin,cap_sys_ptrace=eip' "$binary" 2>/dev/null
}

# Define trusted binary paths (edit as needed for your environment)
TRUSTED_BINARIES=(
    "/opt/himds/himds"
    "/opt/arcproxy/arcproxy"
    "/opt/azcmagent/azcmagent"
    "/opt/gc_linux_service/gc_linux_service"
    "/opt/gc_worker/gc_worker"
)

for binary in "${TRUSTED_BINARIES[@]}"; do
    if [ -f "$binary" ]; then
        owner_uid=$(stat -c '%u' "$binary" 2>/dev/null)
        if [ "$owner_uid" -eq 0 ]; then
            set_binary_permissions "$binary"
        else
            echo "[WARN] Skipping $binary: not owned by root"
        fi
    else
        echo "[INFO] Skipping $binary: not found"
    fi
done

echo "[INFO] Binary permissions configured"


# PART 3: CREATE SYSTEMD SHIMS

echo "[INFO] Finding writable+executable directory for systemd shims..."

SHIM_DIR=""
for dir in /var/bin /tmp/bin /usr/local/bin /volatile/bin; do
    mkdir -p "$dir" 2>/dev/null || continue
    if touch "$dir/.test" 2>/dev/null; then
        rm -f "$dir/.test"
        cat > "$dir/.test_exec.sh" <<'TEST_EOF'
#!/bin/bash
exit 0
TEST_EOF
        chmod +x "$dir/.test_exec.sh" 2>/dev/null
        if "$dir/.test_exec.sh" 2>/dev/null; then
            rm -f "$dir/.test_exec.sh"
            [ -z "$SHIM_DIR" ] && SHIM_DIR="$dir"
            break
        else
            rm -f "$dir/.test_exec.sh"
        fi
    fi
done

if [ -z "$SHIM_DIR" ]; then
    echo "[ERROR] No writable+executable directory found for systemd shims"
    exit 1
fi

echo "[INFO] Using shim directory: $SHIM_DIR"

cat > "$SHIM_DIR/systemctl" <<'SYSTEMCTL_EOF'
#!/bin/bash
mkdir -p /var/log/arc 2>/dev/null
exec 2>> /var/log/arc/systemctl-shim.log
echo "[$(date)] systemctl called with: $*" >&2

SERVICE_NAME=""; COMMAND=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        status|is-active|is-enabled|is-failed|start|stop|restart|reload|enable|disable|mask|unmask)
            COMMAND="$1"; shift; SERVICE_NAME="$1"; shift ;;
        list-units|list-unit-files|daemon-reload|reset-failed)
            COMMAND="$1"; shift ;;
        --all|-a|--no-pager|--no-legend|--plain|--full|--state=*|--type=*)
            shift ;;
        --version)
            echo "systemctl 245 (245.4-4ubuntu3) - SHIM for Arc agent"
            exit 0 ;;
        --help|-h)
            echo "systemctl [OPTIONS...] COMMAND [NAME...]"
            exit 0 ;;
        *) shift ;;
    esac
done

SERVICE_NAME="${SERVICE_NAME%.service}"

map_service() {
    case "$1" in
        extd|extension*|Extension*|"Extension Service") echo "/etc/init.d/extd" ;;
        gcad|guestconfig*|GuestConfig*|"GC Service") echo "/etc/init.d/gcad" ;;
        arcproxyd|arcproxy|ArcProxy*|"Azure Arc Proxy") echo "/etc/init.d/arcproxyd" ;;
        himdsd|himds) echo "/etc/init.d/himdsd" ;;
        azcmagent|"Agent Service") echo "/etc/init.d/himdsd" ;;
        sshd|ssh) echo "/etc/init.d/sshd" ;;
        *) echo "" ;;
    esac
}

case "$COMMAND" in
    status)
        INIT_SCRIPT=$(map_service "$SERVICE_NAME")
        if [ -n "$INIT_SCRIPT" ] && [ -f "$INIT_SCRIPT" ]; then
            echo "â— ${SERVICE_NAME}.service"
            echo "   Loaded: loaded (/etc/init.d/${SERVICE_NAME}; enabled)"
            status_output=$($INIT_SCRIPT status 2>&1)
            if echo "$status_output" | grep -iq "running\|OK.*PID\|active"; then
                echo "   Active: active (running)"
                exit 0
            else
                echo "   Active: inactive (dead)"
                exit 3
            fi
        else
            exit 4
        fi ;;
    is-active)
        INIT_SCRIPT=$(map_service "$SERVICE_NAME")
        if [ -n "$INIT_SCRIPT" ] && [ -f "$INIT_SCRIPT" ]; then
            $INIT_SCRIPT status 2>&1 | grep -iq "running\|OK.*PID\|active" && echo "active" && exit 0
            echo "inactive"; exit 3
        else
            echo "unknown"; exit 3
        fi ;;
    is-enabled)
        INIT_SCRIPT=$(map_service "$SERVICE_NAME")
        [ -n "$INIT_SCRIPT" ] && [ -f "$INIT_SCRIPT" ] && echo "enabled" && exit 0
        echo "disabled"; exit 1 ;;
    start|stop|restart|reload)
        INIT_SCRIPT=$(map_service "$SERVICE_NAME")
        if [ -n "$INIT_SCRIPT" ] && [ -f "$INIT_SCRIPT" ]; then
            [ "$COMMAND" = "reload" ] && COMMAND="restart"
            $INIT_SCRIPT $COMMAND; exit $?
        else
            exit 5
        fi ;;
    enable|disable|mask|unmask|daemon-reload|reset-failed)
        exit 0 ;;
    list-units|list-unit-files)
        echo "UNIT                          LOAD   ACTIVE SUB"
        for script in /etc/init.d/{extd,gcad,arcproxyd,himdsd}; do
            if [ -f "$script" ]; then
                svc=$(basename "$script")
                $script status 2>&1 | grep -iq "running" && \
                printf "%-30s loaded active running\n" "${svc}.service" || \
                printf "%-30s loaded inactive dead\n" "${svc}.service"
            fi
        done
        exit 0 ;;
    *) exit 0 ;;
esac
SYSTEMCTL_EOF

chmod +x "$SHIM_DIR/systemctl"
mkdir -p /var/log/arc

for util in systemd systemd-notify journalctl service; do
    cat > "$SHIM_DIR/$util" <<'EOF'
#!/bin/bash
exit 0
EOF
    chmod +x "$SHIM_DIR/$util"
done

# PART 4: EXTRACT ARC MACHINE IDENTITY

RESOURCE_ID=""
if [ -f /var/opt/azcmagent/agentconfig.json ]; then
    RESOURCE_ID=$(grep '"resourceId"' /var/opt/azcmagent/agentconfig.json 2>/dev/null | sed 's/.*"resourceId"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' | head -1) || { echo "[WARN] Failed to extract resourceId from agentconfig.json"; RESOURCE_ID=""; }
fi

if [ -z "$RESOURCE_ID" ] || [ "$RESOURCE_ID" = "null" ]; then
    RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.HybridCompute/machines/${MACHINE_NAME}"
fi

# PART 5: CONFIGURE SYSTEM ENVIRONMENT

echo "[INFO] Configuring system environment (SHIM_DIR=$SHIM_DIR)..."

cat > /etc/environment <<ENVEOF
IMDS_ENDPOINT=http://localhost:40342
IDENTITY_ENDPOINT=http://localhost:40342/metadata/identity/oauth2/token
AZGUESTCONFIG_ENDPOINT=http://localhost:40343
EXTENSION_SERVICE_URL=http://localhost:40343
PATH=${SHIM_DIR}:/usr/bin:/usr/sbin:/bin:/sbin
AZURE_RESOURCE_GROUP=${RESOURCE_GROUP}
AZURE_LOCATION=${REGION}
ARM_RESOURCE_ID=${RESOURCE_ID}
SUBSCRIPTION_ID=${SUBSCRIPTION_ID}
TENANT_ID=${TENANT_ID}
SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
NODE_TLS_REJECT_UNAUTHORIZED=0
AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
ENVEOF

mkdir -p /etc/profile.d 2>/dev/null
cat > /etc/profile.d/arc-environment.sh <<PROFEOF
#!/bin/bash
export PATH="${SHIM_DIR}:\$PATH"
export IMDS_ENDPOINT="http://localhost:40342"
export IDENTITY_ENDPOINT="http://localhost:40342/metadata/identity/oauth2/token"
export AZGUESTCONFIG_ENDPOINT="http://localhost:40343"
export EXTENSION_SERVICE_URL="http://localhost:40343"
export ARM_RESOURCE_ID="${RESOURCE_ID}"
export AZURE_RESOURCE_GROUP="${RESOURCE_GROUP}"
export AZURE_LOCATION="${REGION}"
export SUBSCRIPTION_ID="${SUBSCRIPTION_ID}"
export TENANT_ID="${TENANT_ID}"
export SSL_CERT_FILE="/etc/ssl/certs/ca-certificates.crt"
export CURL_CA_BUNDLE="/etc/ssl/certs/ca-certificates.crt"
export NODE_TLS_REJECT_UNAUTHORIZED=0
PROFEOF

chmod +x /etc/profile.d/arc-environment.sh

# Source environment variables for immediate use
if [ -f /etc/profile.d/arc-environment.sh ]; then
    source /etc/profile.d/arc-environment.sh
    echo "[INFO] Environment variables sourced successfully"
else
    echo "[ERROR] Failed to create environment file"
    exit 1
fi

mkdir -p /var/opt/azcmagent/{log,tokens,arcproxy}
mkdir -p /var/lib/{waagent,GuestConfig/Configuration,GuestConfig/Extension/{status,config}}
mkdir -p /var/log/arc
chmod 700 /var/opt/azcmagent/tokens
chmod 755 /var/lib/GuestConfig/{Extension,Configuration}

# PART 6: CREATE INIT SCRIPTS

create_service_script() {
    local service_name="${1:-}"
    local script_path="${2:-}"
    local daemon_pattern="${3:-}"
    local pidfile="/var/run/${service_name}.pid"
    local logfile="/var/log/arc/${service_name}.log"

    if [ "$service_name" = "himdsd" ]; then
        cat > "$script_path" <<'HIMDS_EOF'
#!/bin/bash
DAEMON="himds"
PIDFILE="/var/run/himds.pid"
LOGFILE="/var/log/arc/himds.log"

DAEMON_PATH=$(find /opt /var 2>/dev/null | grep -E "/himds$" | grep -v ".bak\|.old\|.backup" | head -1)

if [ -z "$DAEMON_PATH" ]; then
    echo "ERROR: himds binary not found"
    exit 1
fi

start() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        return 0
    fi
    
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    rm -f /var/opt/azcmagent/socks/himds.sock 2>/dev/null
    sleep 2
    
    mkdir -p /var/opt/azcmagent/socks $(dirname $LOGFILE)
    
    export PATH="/var/bin:/tmp/bin:/usr/local/bin:/volatile/bin:/usr/bin:/usr/sbin:/bin:/sbin"
    export IMDS_ENDPOINT="http://localhost:40342"
    export IDENTITY_ENDPOINT="http://localhost:40342/metadata/identity/oauth2/token"
    
    cd $(dirname $DAEMON_PATH)
    nohup $DAEMON_PATH >> $LOGFILE 2>&1 &
    PID=$!
    echo $PID > $PIDFILE
    
    for i in {1..20}; do
        if [ -e /var/opt/azcmagent/socks/himds.sock ] && ps -p $PID > /dev/null 2>&1; then
            return 0
        fi
        sleep 1
    done
    
    return 1
}

stop() {
    [ -f $PIDFILE ] && kill $(cat $PIDFILE) 2>/dev/null
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    rm -f $PIDFILE
}

status() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        echo "HIMDS is running (PID $(cat $PIDFILE))"
        return 0
    else
        echo "HIMDS is stopped"
        return 3
    fi
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 2; start ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}" ;;
esac
HIMDS_EOF
    else
        # Generic service template for other services
        cat > "$script_path" <<'GENERIC_EOF'
#!/bin/bash
SERVICE_NAME="{SERVICE_NAME}"
PIDFILE="/var/run/{SERVICE_NAME}.pid"
LOGFILE="/var/log/arc/{SERVICE_NAME}.log"
DAEMON_PATTERN="{DAEMON_PATTERN}"

DAEMON_PATH=$(find /opt /var 2>/dev/null | grep -E "$DAEMON_PATTERN" | grep -v ".bak\|.old" | head -1)

if [ -z "$DAEMON_PATH" ]; then
    echo "ERROR: $DAEMON_PATTERN binary not found"
    exit 1
fi

start() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        return 0
    fi
    
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    fuser -k -9 40343/tcp 2>/dev/null
    fuser -k -9 40344/tcp 2>/dev/null
    rm -f $PIDFILE
    sleep 3
    
    mkdir -p $(dirname $LOGFILE)
    [ -f /etc/profile.d/arc-environment.sh ] && source /etc/profile.d/arc-environment.sh
    
    nohup $DAEMON_PATH >> $LOGFILE 2>&1 &
    PID=$!
    echo $PID > $PIDFILE
    sleep 5
    
    if ps -p $PID > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

stop() {
    if [ -f $PIDFILE ]; then
        kill -9 $(cat $PIDFILE) 2>/dev/null
        rm -f $PIDFILE
    fi
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    fuser -k -9 40343/tcp 2>/dev/null
    fuser -k -9 40344/tcp 2>/dev/null
    sleep 3
}

restart() {
    stop
    sleep 5
    start
}

status() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        echo "$SERVICE_NAME is running (PID $(cat $PIDFILE))"
        return 0
    else
        echo "$SERVICE_NAME is stopped"
        return 3
    fi
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) restart ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}" ;;
esac
GENERIC_EOF
        sed -i "s|{SERVICE_NAME}|$service_name|g; s|{DAEMON_PATTERN}|$daemon_pattern|g" "$script_path"
    fi
    
    chmod +x "$script_path"
}

# Create HIMDS service
create_service_script "himdsd" "/etc/init.d/himdsd"

# Create ArcProxy service
cat > /etc/init.d/arcproxyd <<'ARCPROXY_EOF'
#!/bin/bash
DAEMON="arcproxy"
PIDFILE="/var/run/arcproxy.pid"
LOGFILE="/var/log/arc/arcproxy.log"

DAEMON_PATH=$(find /opt /var 2>/dev/null | grep -E "/arcproxy$" | grep -v ".bak\|.old" | head -1)

if [ -z "$DAEMON_PATH" ]; then
    echo "ERROR: arcproxy binary not found"
    exit 1
fi

start() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        return 0
    fi
    
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    fuser -k -9 40343/tcp 2>/dev/null
    fuser -k -9 40344/tcp 2>/dev/null
    rm -f $PIDFILE
    sleep 3
    
    mkdir -p $(dirname $LOGFILE)
    [ -f /etc/profile.d/arc-environment.sh ] && source /etc/profile.d/arc-environment.sh
    
    nohup $DAEMON_PATH >> $LOGFILE 2>&1 &
    PID=$!
    echo $PID > $PIDFILE
    sleep 5
    
    if ps -p $PID > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

stop() {
    if [ -f $PIDFILE ]; then
        kill -9 $(cat $PIDFILE) 2>/dev/null
        rm -f $PIDFILE
    fi
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    fuser -k -9 40343/tcp 2>/dev/null
    fuser -k -9 40344/tcp 2>/dev/null
    sleep 3
}

restart() {
    stop
    sleep 5
    start
}

status() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        echo "ArcProxy is running (PID $(cat $PIDFILE))"
        return 0
    else
        echo "ArcProxy is stopped"
        return 3
    fi
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) restart ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}" ;;
esac
ARCPROXY_EOF

chmod +x /etc/init.d/arcproxyd

# Create EXTD service (Extension Service)
cat > /etc/init.d/extd <<'EXTD_EOF'
#!/bin/bash
DAEMON="gc_linux_service"
PIDFILE="/var/run/extd.pid"
LOGFILE="/var/log/arc/extd.log"

DAEMON_PATH=$(find /opt /var 2>/dev/null | grep -E "/GC_Ext.*gc_linux_service$" | grep -v ".bak\|.old" | head -1)
GC_PATH=$(dirname "$DAEMON_PATH" 2>/dev/null)

if [ -z "$DAEMON_PATH" ] || [ ! -f "$DAEMON_PATH" ]; then
    echo "ERROR: EXTD binary not found"
    exit 1
fi

start() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        return 0
    fi
    
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    rm -f $PIDFILE
    sleep 2
    
    mkdir -p $(dirname $LOGFILE) /var/lib/GuestConfig/Extension/{status,config} /var/lib/waagent
    cd $GC_PATH
    
    ARM_RES_ID=""
    if [ -f /var/opt/azcmagent/agentconfig.json ]; then
        ARM_RES_ID=$(grep '"resourceId"' /var/opt/azcmagent/agentconfig.json 2>/dev/null | sed 's/.*"resourceId"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' | head -1)
    fi
    
    [ -z "$ARM_RES_ID" ] && ARM_RES_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.HybridCompute/machines/${MACHINE_NAME}"
    
    [ -f /etc/profile.d/arc-environment.sh ] && source /etc/profile.d/arc-environment.sh
    
    env - PATH="/var/bin:/tmp/bin:/usr/local/bin:/volatile/bin:/usr/bin:/usr/sbin:/bin:/sbin" \
        IDENTITY_ENDPOINT="http://localhost:40342/metadata/identity/oauth2/token" \
        IMDS_ENDPOINT="http://localhost:40342" \
        AZGUESTCONFIG_ENDPOINT="http://localhost:40343" \
        EXTENSION_SERVICE_URL="http://localhost:40343" \
        ARM_RESOURCE_ID="$ARM_RES_ID" \
        LD_LIBRARY_PATH="$GC_PATH" \
        AZURE_GUEST_AGENT_EXTENSION_PATH="/var/lib/waagent" \
        AZURE_GUEST_AGENT_EXTENSION_SUPPORTED_FEATURES="ExtensionTelemetryPipeline,PersistentExtensions" \
        AZURE_HTTP_USER_AGENT="GuestConfiguration/Extension" \
        nohup $DAEMON_PATH >> $LOGFILE 2>&1 &
    
    PID=$!
    echo $PID > $PIDFILE
    sleep 8
    
    if ps -p $PID > /dev/null 2>&1; then
        return 0
    else
        rm -f $PIDFILE
        return 1
    fi
}

stop() {
    [ -f $PIDFILE ] && kill $(cat $PIDFILE) 2>/dev/null
    pkill -f "$DAEMON_PATH" 2>/dev/null
    rm -f $PIDFILE
}

status() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        echo "EXTD is running (PID $(cat $PIDFILE))"
        return 0
    else
        echo "EXTD is stopped"
        return 3
    fi
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 2; start ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}" ;;
esac
EXTD_EOF

chmod +x /etc/init.d/extd

# Create GCAD service (Guest Configuration Agent)
cat > /etc/init.d/gcad <<'GCAD_EOF'
#!/bin/bash
DAEMON="gc_linux_service"
PIDFILE="/var/run/gcad.pid"
LOGFILE="/var/log/arc/gcad.log"

DAEMON_PATH=$(find /opt /var 2>/dev/null | grep -E "/GC_Service.*gc_linux_service$" | grep -v ".bak\|.old" | head -1)
GC_PATH=$(dirname "$DAEMON_PATH" 2>/dev/null)

if [ -z "$DAEMON_PATH" ] || [ ! -f "$DAEMON_PATH" ]; then
    echo "ERROR: GCAD binary not found"
    exit 1
fi

start() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        return 0
    fi
    
    pkill -9 -f "$DAEMON_PATH" 2>/dev/null
    rm -f $PIDFILE
    sleep 2
    
    mkdir -p $(dirname $LOGFILE) /var/lib/GuestConfig/Configuration
    cd $GC_PATH
    
    ARM_RES_ID=""
    if [ -f /var/opt/azcmagent/agentconfig.json ]; then
        ARM_RES_ID=$(grep '"resourceId"' /var/opt/azcmagent/agentconfig.json 2>/dev/null | sed 's/.*"resourceId"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' | head -1)
    fi
    
    [ -z "$ARM_RES_ID" ] && ARM_RES_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.HybridCompute/machines/${MACHINE_NAME}"
    
    [ -f /etc/profile.d/arc-environment.sh ] && source /etc/profile.d/arc-environment.sh
    
    env - PATH="${SHIM_DIR}:/usr/bin:/usr/sbin:/bin:/sbin" \
        IDENTITY_ENDPOINT="http://localhost:40342/metadata/identity/oauth2/token" \
        IMDS_ENDPOINT="http://localhost:40342" \
        AZGUESTCONFIG_ENDPOINT="http://localhost:40343" \
        ARM_RESOURCE_ID="$ARM_RES_ID" \
        LD_LIBRARY_PATH="$GC_PATH" \
        AZURE_GUEST_CONFIGURATION_PATH="/var/lib/GuestConfig/Configuration" \
        AZURE_HTTP_USER_AGENT="GuestConfiguration/Agent" \
        nohup $DAEMON_PATH >> $LOGFILE 2>&1 &
    
    PID=$!
    echo $PID > $PIDFILE
    sleep 8
    
    if ps -p $PID > /dev/null 2>&1; then
        return 0
    else
        rm -f $PIDFILE
        return 1
    fi
}

stop() {
    [ -f $PIDFILE ] && kill $(cat $PIDFILE) 2>/dev/null
    pkill -f "$DAEMON_PATH" 2>/dev/null
    rm -f $PIDFILE
}

status() {
    if [ -f $PIDFILE ] && ps -p $(cat $PIDFILE) > /dev/null 2>&1; then
        echo "GCAD is running (PID $(cat $PIDFILE))"
        return 0
    else
        echo "GCAD is stopped"
        return 3
    fi
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 2; start ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}" ;;
esac
GCAD_EOF

chmod +x /etc/init.d/gcad

# PART 7: RESTART ALL SERVICES

echo "[INFO] Stopping services..."
for service in gcad extd arcproxyd himdsd; do
    if [ -f "/etc/init.d/$service" ]; then
        echo "[INFO] Stopping $service..."
        /etc/init.d/$service stop 2>/dev/null || echo "[WARN] Failed to stop $service (may not be running)"
    else
        echo "[WARN] Service script for $service not found at /etc/init.d/$service"
    fi
done

sleep 5
echo "[INFO] Force killing remaining processes..."
pkill -9 -f "gc_linux_service" 2>/dev/null || true
pkill -9 -f "arcproxy" 2>/dev/null || true
pkill -9 -f "himds" 2>/dev/null || true
for port in 40342 40343 40344; do
    echo "[INFO] Releasing port $port..."
    fuser -k -9 $port/tcp 2>/dev/null || true
done
rm -f /var/run/*.pid 2>/dev/null || true
rm -f /var/opt/azcmagent/socks/himds.sock 2>/dev/null || true
sleep 3

echo "[INFO] Starting services..."
if [ -f "/etc/init.d/himdsd" ]; then
    echo "[INFO] Starting himdsd..."
    /etc/init.d/himdsd start || echo "[WARN] Failed to start himdsd"
else
    echo "[ERROR] himdsd service script not found"
fi
sleep 5

if [ -f "/etc/init.d/arcproxyd" ]; then
    echo "[INFO] Starting arcproxyd..."
    /etc/init.d/arcproxyd start || echo "[WARN] Failed to start arcproxyd"
else
    echo "[ERROR] arcproxyd service script not found"
fi
sleep 5

if [ -f "/etc/init.d/extd" ]; then
    echo "[INFO] Starting extd..."
    /etc/init.d/extd start || echo "[WARN] Failed to start extd"
else
    echo "[ERROR] extd service script not found"
fi
sleep 8

if [ -f "/etc/init.d/gcad" ]; then
    echo "[INFO] Starting gcad..."
    /etc/init.d/gcad start || echo "[WARN] Failed to start gcad"
else
    echo "[ERROR] gcad service script not found"
fi
sleep 8

echo "[INFO] Setup complete. Checking service status..."
for service in himdsd arcproxyd extd gcad; do
    if [ -f "/etc/init.d/$service" ]; then
        echo "[INFO] Status of $service:"
        /etc/init.d/$service status || echo "[WARN] Could not get status for $service"
    else
        echo "[WARN] Service script for $service not found"
    fi
done

# PART 8: DOWNLOAD AND INSTALL PARSER

echo "[INFO] Downloading and installing Cisco parser..."
cd /opt
parser_file="cisco-parser.tar.gz"
if ! wget -q "$PARSER_URL" -O "$parser_file"; then
    echo "[ERROR] Failed to download parser from $PARSER_URL"
    exit 1
fi

if ! tar -xzf "$parser_file"; then
    echo "[ERROR] Failed to extract parser archive"
    rm -f "$parser_file"
    exit 1
fi
rm -f "$parser_file"

# Verify parser binary was extracted and is executable
if [ ! -x "$PARSER_PATH" ]; then
    echo "[ERROR] Parser binary not found or not executable at $PARSER_PATH"
    exit 1
fi
echo "[INFO] Parser installed and verified at $PARSER_PATH"

# Verify Arc installation succeeded
if ! command -v azcmagent >/dev/null 2>&1; then
    echo "[WARN] azcmagent command not found in PATH, checking /opt/azcmagent"
fi

# Set permissions on any newly installed Arc binaries
echo "[INFO] Securing Arc agent binaries..."
find /opt/azcmagent -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || echo "[WARN] Could not set permissions on Arc scripts"
find /var/tmp -name "rpm-tmp.*" -type f -exec chmod +x {} \; 2>/dev/null || true

# PART 9: CREATE SIGNATURE GENERATOR

cat > /opt/azure-signature-generator.sh << 'SIG_EOF'
#!/bin/bash
generate_signature() {
    local workspace_id="$1"
    local shared_key="$2" 
    local date="$3"
    local content_length="$4"
    local string_to_sign="POST\n${content_length}\napplication/json\nx-ms-date:${date}\n/api/logs"
    local decoded_key=$(echo -n "$shared_key" | base64 -d)
    local signature=$(echo -en "$string_to_sign" | openssl dgst -sha256 -mac hmac -macopt key:"$decoded_key" -binary | base64)
    echo "SharedKey ${workspace_id}:${signature}"
}
export -f generate_signature
SIG_EOF

chmod +x /opt/azure-signature-generator.sh

# PART 10: CREATE AZURE LOGGER

cat > /opt/cisco-azure-logger-v2.sh << LOGGER_EOF
#!/bin/bash
WORKSPACE_ID="${WORKSPACE_ID}"
PRIMARY_KEY="${PRIMARY_KEY}"
SECONDARY_KEY="${SECONDARY_KEY}"
SHARED_KEY="\$PRIMARY_KEY"
TEMP_DIR="${AZURE_TEMP_DIR}"

mkdir -p "\$TEMP_DIR"

source /opt/azure-signature-generator.sh

send_to_azure_custom_table() {
    local json_data="\$1"
    local table_name="\$2"
    local timestamp=\$(date -u +"%a, %d %b %Y %H:%M:%S GMT")
    
    local temp_payload="\$TEMP_DIR/payload_\$\$.json"
    echo -n "\$json_data" > "\$temp_payload"
    
    local content_length=\$(stat -c%s "\$temp_payload" 2>/dev/null || stat -f%z "\$temp_payload" 2>/dev/null)
    
    local authorization=\$(generate_signature "\$WORKSPACE_ID" "\$SHARED_KEY" "\$timestamp" "\$content_length")
    
    local response=\$(curl -k -s -w "\\nHTTP_CODE:%{http_code}" -X POST \\
        -H "Content-Type: application/json" \\
        -H "Log-Type: \$table_name" \\
        -H "x-ms-date: \$timestamp" \\
        -H "Authorization: \$authorization" \\
        --data-binary "@\${temp_payload}" \\
        "https://\${WORKSPACE_ID}.ods.opinsights.azure.com/api/logs?api-version=2016-04-01")
    
    rm -f "\$temp_payload"
    
    local http_code=\$(echo "\$response" | grep "HTTP_CODE:" | cut -d: -f2)
    
    if [ "\$http_code" = "200" ]; then
        return 0
    else
        if [ "\$SHARED_KEY" = "\$PRIMARY_KEY" ] && [ ! -z "\$SECONDARY_KEY" ]; then
            SHARED_KEY="\$SECONDARY_KEY"
            send_to_azure_custom_table "\$json_data" "\$table_name"
            return \$?
        fi
        return 1
    fi
}

add_metadata_simple() {
    local json_input="\$1"
    local hostname="\$2"
    
    if command -v python3 >/dev/null 2>&1; then
        echo "\$json_input" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if isinstance(data, list):
        for item in data:
            item['hostname'] = '\$hostname'
            item['device_type'] = 'cisco-nx-os'
    else:
        data['hostname'] = '\$hostname'
        data['device_type'] = 'cisco-nx-os'
        data = [data]
    print(json.dumps(data))
except:
    sys.exit(1)
"
        return \$?
    elif command -v python >/dev/null 2>&1; then
        echo "\$json_input" | python -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if isinstance(data, list):
        for item in data:
            item['hostname'] = '\$hostname'
            item['device_type'] = 'cisco-nx-os'
    else:
        data['hostname'] = '\$hostname'
        data['device_type'] = 'cisco-nx-os'
        data = [data]
    print(json.dumps(data))
except:
    sys.exit(1)
"
        return \$?
    else
        echo "\$json_input"
        return 0
    fi
}

process_and_send() {
    local parser_output="\$1"
    local table_name="\$2"
    local hostname=\$(hostname)
    
    if [ -z "\$parser_output" ]; then
        return 1
    fi
    
    local azure_json=\$(add_metadata_simple "\$parser_output" "\$hostname")
    
    if [ \$? -ne 0 ] || [ -z "\$azure_json" ]; then
        return 1
    fi
    
    send_to_azure_custom_table "\$azure_json" "\$table_name"
    return \$?
}

export -f send_to_azure_custom_table
export -f process_and_send

case "\$1" in
    "send")
        if [ -z "\$2" ] || [ -z "\$3" ]; then
            exit 1
        fi
        
        table_name="\$2"
        json_source="\$3"
        
        if [ "\$json_source" = "-" ]; then
            json_data=\$(cat)
        elif [ -f "\$json_source" ]; then
            json_data=\$(cat "\$json_source")
        else
            exit 1
        fi
        
        process_and_send "\$json_data" "\$table_name"
        ;;
    "test")
        test_data='[{"test":"connection","timestamp":"'\$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}]'
        send_to_azure_custom_table "\$test_data" "CiscoSwitchTest"
        ;;
    *)
        exit 1
        ;;
esac
LOGGER_EOF

chmod +x /opt/cisco-azure-logger-v2.sh


# PART 11: CREATE PARSER COLLECTOR

cat > /opt/cisco-parser-collector.sh << COLLECTOR_EOF
#!/bin/bash
export PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/isan/bin:/isan/sbin:\$PATH

PARSER_PATH="${PARSER_PATH}"
LOGGER_PATH="/opt/cisco-azure-logger-v2.sh"
TEMP_DIR="${TEMP_DIR}"
LOG_FILE="/var/log/cisco-parser-collector.log"

mkdir -p "\$TEMP_DIR"

log_message() {
    echo "[\$(date '+%Y-%m-%d %H:%M:%S')] \$1" >> "\$LOG_FILE"
}

run_and_process() {
    local command_name="${1:-}"
    local vsh_command="${2:-}"
    local parser_type="${3:-}"
    local table_name="${4:-}"
    
    local temp_input="\$TEMP_DIR/\${command_name}-input.txt"
    local temp_output="\$TEMP_DIR/\${command_name}-output.json"
    
    if ! vsh -c "\$vsh_command" > "\$temp_input" 2>&1; then
        return 1
    fi
    
    if [ ! -s "\$temp_input" ]; then
        return 1
    fi
    
    if ! "\$PARSER_PATH" -p "\$parser_type" -i "\$temp_input" -o "\$temp_output" >> "\$LOG_FILE" 2>&1; then
        return 1
    fi
    
    if [ ! -s "\$temp_output" ]; then
        return 1
    fi
    
    if "\$LOGGER_PATH" send "\$table_name" "\$temp_output" >> "\$LOG_FILE" 2>&1; then
        rm -f "\$temp_input" "\$temp_output"
        return 0
    else
        return 1
    fi
}

process_command() {
    local cmd_name="${1:-}"
    local vsh_cmd="${2:-}"
    local parser_type="${3:-}"
    local table_name="${4:-}"
    
    if run_and_process "\$cmd_name" "\$vsh_cmd" "\$parser_type" "\$table_name"; then
        return 0
    else
        return 1
    fi
}

main() {
    log_message "Collection cycle started"
    
    local success_count=0
    local failure_count=0
    
    # Define commands: (command_name:vsh_command:parser_type:table_name)
    local commands=(
        "class-map:show class-map:class-map:CiscoClassMap"
        "interface-counters:show interface counter:interface-counters:CiscoInterfaceCounter"
        "inventory:show inventory all:inventory:CiscoInventory"
        "ip-arp:show ip arp:ip-arp:CiscoIpArp"
        "ip-route:show ip route:ip-route:CiscoIpRoute"
        "lldp-neighbor:show lldp neighbor detail:lldp-neighbor:CiscoLldpNeighbor"
        "mac-address:show mac address-table:mac-address:CiscoMacAddress"
        "transceiver:show interface transceiver:transceiver:CiscoTransceiver"
        "env-temp:show environment temperature:environment-temperature:CiscoEnvTemp"
        "interface-errors:show interface counters errors:interface-error-counters:CiscoInterfaceErrors"
        "env-power:show environment power detail:environment-power:CiscoEnvPower"
        "system-resources:show system resources:system-resources:CiscoSystemResources"
        "system-uptime:show system uptime:system-uptime:CiscoSystemUptime"
        "bgp-all-summary:show bgp all summary:bgp-all-summary:CiscoBgpSummary"
    )
    
    for cmd_config in "\${commands[@]}"; do
        IFS=':' read -r cmd_name vsh_cmd parser_type table_name <<< "\$cmd_config"
        if process_command "\$cmd_name" "\$vsh_cmd" "\$parser_type" "\$table_name"; then
            ((success_count++))
        else
            ((failure_count++))
        fi
        sleep 2
    done
    
    log_message "Collection complete: \$success_count success, \$failure_count failures"
    
    find "\$TEMP_DIR" -type f -mmin +60 -delete 2>/dev/null
    
    if [ -f "\$LOG_FILE" ] && [ \$(stat -f%z "\$LOG_FILE" 2>/dev/null || stat -c%s "\$LOG_FILE" 2>/dev/null) -gt 10485760 ]; then
        mv "\$LOG_FILE" "\${LOG_FILE}.old"
    fi
}

main
exit 0
COLLECTOR_EOF

chmod +x /opt/cisco-parser-collector.sh

# PART 12: SETUP CRON JOB

echo "[INFO] Configuring cron job for telemetry collection..."

# Verify vsh is available before adding cron job
if ! command -v vsh >/dev/null 2>&1; then
    echo "[WARN] vsh command not found - this script must run on a Cisco switch"
    echo "[WARN] Cron job setup skipped - vsh is required for parser collector"
else
    cat > /tmp/cisco-cron-temp << 'CRON_EOF'
* * * * * /opt/cisco-parser-collector.sh
CRON_EOF

    crontab -l > /tmp/current-cron 2>/dev/null || true
    if ! grep -q 'cisco-parser-collector' /tmp/current-cron; then
        cat /tmp/current-cron /tmp/cisco-cron-temp | crontab -
        echo "[INFO] Cron job added successfully"
    else
        echo "[INFO] Cron job already exists, skipping"
    fi
    rm -f /tmp/cisco-cron-temp /tmp/current-cron

    # Verify cron job was added
    if crontab -l 2>/dev/null | grep -q 'cisco-parser-collector'; then
        echo "[INFO] Cron job verified and active"
    else
        echo "[WARN] Cron job may not be active, verify with: crontab -l"
    fi
fi

echo "============================================================================"
echo "[SUCCESS] Azure Arc Setup Script Completed Successfully!"
echo "============================================================================"
echo ""
echo "Configuration Summary:"
echo "  Region: $REGION"
echo "  Resource Group: $RESOURCE_GROUP"
echo "  Machine Name: $MACHINE_NAME"
echo "  Shim Directory: $SHIM_DIR"
echo "  Parser Path: $PARSER_PATH"
echo "  Workspace ID: ${WORKSPACE_ID:0:8}..." 
echo ""
echo "NEXT STEPS:"
echo "1. Connect the Arc agent to Azure (see README.md for instructions)"
echo "2. Verify Arc agent connection with: azcmagent show"
echo "3. Check service status with: for svc in himdsd arcproxyd extd gcad; do echo -n \"\$svc: \"; /etc/init.d/\$svc status | head -1; done"
echo "4. Check cron job: crontab -l | grep cisco-parser-collector"
echo "5. View logs in /var/log/arc/"
echo "6. Run diagnostic: /opt/arc-diagnostics.sh (once created)"
echo ""
echo "============================================================================"